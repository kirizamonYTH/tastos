<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Base Airdrop Eligibility — Checker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style> :root { color-scheme: dark; } body{background:#071022;color:#e6eef8} .mono{font-family:ui-monospace,Menlo,Monaco,"Roboto Mono",monospace} </style>
</head>
<body class="min-h-screen flex items-start justify-center p-6">
  <div class="w-full max-w-4xl">
    <header class="mb-6">
      <h1 class="text-2xl font-semibold">Base Airdrop Eligibility Checker</h1>
      <p class="text-sm text-slate-300 mt-1">Server proxy: <span class="mono">/api/check</span>. Keep your BaseScan API key in Vercel env (<span class="mono">BASESCAN_API_KEY</span>).</p>
    </header>

    <main class="bg-[#061126] border border-[#123] rounded-lg p-5 shadow-lg">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <input id="wallet" placeholder="0x..." class="col-span-2 p-2 rounded bg-[#051029] border border-[#123] mono text-sm" />
        <select id="mode" class="p-2 rounded bg-[#051029] border border-[#123] text-sm">
          <option value="full" selected>Full analysis</option>
          <option value="quick">Quick</option>
        </select>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
        <button id="btnAnalyze" class="col-span-2 bg-[#0ea5a3] hover:bg-[#0b8f8d] text-black font-semibold py-2 rounded">Analyze Wallet</button>
        <div class="flex gap-2">
          <button id="btnReset" class="bg-transparent border border-[#234] text-slate-300 py-2 rounded">Reset</button>
          <button id="btnExport" class="bg-[#334155] text-slate-200 py-2 px-3 rounded">Export CSV</button>
        </div>
      </div>

      <div id="status" class="text-sm text-slate-300 mb-4"></div>

      <article id="report" class="hidden bg-[#041226] border border-[#123] rounded p-4 text-sm space-y-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-xs text-slate-400">Wallet</div>
            <div id="addr" class="mono text-sm"></div>
          </div>
          <div class="text-right">
            <div class="text-xs text-slate-400">Tier</div>
            <div id="tier" class="text-white font-semibold"></div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="p-3 bg-[#04101a] rounded border border-[#102233]">
            <div class="text-xs text-slate-400 mb-2">On-chain Snapshot</div>
            <div class="text-sm"><span class="text-slate-300">Normal txs:</span> <span id="txs" class="mono font-medium"></span></div>
            <div class="text-sm"><span class="text-slate-300">Token transfers:</span> <span id="tokentxs" class="mono font-medium"></span></div>
            <div class="text-sm"><span class="text-slate-300">Internal txs:</span> <span id="internaltxs" class="mono font-medium"></span></div>
            <div class="text-sm"><span class="text-slate-300">Counterparties (unique):</span> <span id="cp" class="mono font-medium"></span></div>
            <div class="text-sm"><span class="text-slate-300">Months active:</span> <span id="months" class="mono font-medium"></span></div>
          </div>

          <div class="p-3 bg-[#04101a] rounded border border-[#102233]">
            <div class="text-xs text-slate-400 mb-2">Eligibility / Heuristics</div>
            <div class="text-sm"><span class="text-slate-300">Bridged:</span> <span id="bridged" class="mono"></span></div>
            <div class="text-sm"><span class="text-slate-300">dApp interactions (proxy):</span> <span id="dappcount" class="mono"></span></div>
            <div class="text-sm"><span class="text-slate-300">Sybil risk:</span> <span id="sybil" class="mono"></span></div>
            <div class="text-sm"><span class="text-slate-300">Final score (0-100):</span> <span id="score" class="mono font-semibold"></span></div>
          </div>
        </div>

        <div class="p-3 bg-[#04101a] rounded border border-[#102233]">
          <div class="text-xs text-slate-400 mb-2">Estimated Airdrop Value (USD)</div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
            <div class="p-2 bg-[#051226] rounded">
              <div class="text-xs text-slate-400">Builder (25%)</div>
              <div id="builderVal" class="mono font-medium mt-1"></div>
            </div>
            <div class="p-2 bg-[#051226] rounded">
              <div class="text-xs text-slate-400">Creator (35%)</div>
              <div id="creatorVal" class="mono font-medium mt-1"></div>
            </div>
            <div class="p-2 bg-[#051226] rounded">
              <div class="text-xs text-slate-400">Active (40%)</div>
              <div id="activeVal" class="mono font-medium mt-1"></div>
            </div>
          </div>
          <div class="mt-3 text-sm text-slate-300">
            Estimated for you: <span id="estYou" class="mono font-semibold"></span>
          </div>
        </div>

        <details class="text-xs text-slate-400">
          <summary class="cursor-pointer">Raw sample counterparties (first 50)</summary>
          <pre id="counterpartyRaw" class="text-xs bg-[#02101a] p-2 rounded mt-2 mono overflow-auto max-h-44"></pre>
        </details>
      </article>
    </main>

    <footer class="mt-4 text-xs text-slate-500">Deploy notes: set <span class="mono">BASESCAN_API_KEY</span> in Vercel env. For large-scale scanning add Redis or external cache.</footer>
  </div>

  <script>
    const btnAnalyze = document.getElementById("btnAnalyze");
    const btnReset = document.getElementById("btnReset");
    const btnExport = document.getElementById("btnExport");
    const status = document.getElementById("status");
    const report = document.getElementById("report");
    let lastResult = null;

    function fmtMoney(n){ if(n===null||n===undefined) return "—"; return "$"+Math.round(n).toLocaleString(); }

    btnAnalyze.addEventListener("click", async () => {
      report.classList.add("hidden");
      status.textContent = "Calling server proxy...";

      const addr = (document.getElementById("wallet").value || "").trim();
      if (!/^0x[a-f0-9]{40}$/i.test(addr)) { status.innerHTML = "<span class='text-rose-400'>Invalid wallet address</span>"; return; }

      try {
        const r = await fetch("/api/check", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ address: addr.toLowerCase() }) });
        const j = await r.json();
        if (!j.ok) { status.innerHTML = `<span class='text-rose-400'>Error: ${j.error || 'server'}</span>`; return; }
        lastResult = j;
        renderResult(j);
        status.textContent = j.cached ? "Result (cached)" : "Result (live)";
      } catch (e) {
        console.error(e); status.innerHTML = "<span class='text-rose-400'>Network/server error (see console)</span>";
      }
    });

    function renderResult(data) {
      report.classList.remove("hidden");
      document.getElementById("addr").textContent = data.address;
      const s = data.sample || {};
      document.getElementById("txs").textContent = s.txCount ?? "—";
      document.getElementById("tokentxs").textContent = s.tokenTxCount ?? "—";
      document.getElementById("internaltxs").textContent = s.internalTxCount ?? "—";
      document.getElementById("cp").textContent = s.counterparties_count ?? "—";
      // months
      let months = "—";
      if (s.firstTx && s.lastTx) {
        const f = new Date(Number(s.firstTx) * 1000), l = new Date(Number(s.lastTx) * 1000);
        months = Math.max(0, (l.getFullYear()-f.getFullYear())*12 + (l.getMonth()-f.getMonth()));
      }
      document.getElementById("months").textContent = months;

      document.getElementById("bridged").textContent = data.bridged ? "Yes" : "No";
      document.getElementById("dappcount").textContent = (data.dappCounter ?? "—");
      document.getElementById("sybil").textContent = data.sybilRisk ?? "—";
      document.getElementById("score").textContent = data.score ?? "—";
      document.getElementById("tier").textContent = data.tier ?? "—";

      const est = data.estimates || {};
      document.getElementById("builderVal").textContent = fmtMoney(est.builderPer) + " (est)";
      document.getElementById("creatorVal").textContent = fmtMoney(est.creatorPer) + " (est)";
      document.getElementById("activeVal").textContent = fmtMoney(est.activePerLow) + " - " + fmtMoney(est.activePerHigh) + " (est)";

      let estYou = "—";
      if (data.tier && data.tier.startsWith("Tier 1")) estYou = fmtMoney(est.builderPer);
      else if (data.tier && data.tier.startsWith("Tier 2")) estYou = fmtMoney(est.creatorPer);
      else if (data.tier && data.tier.startsWith("Tier 3")) estYou = fmtMoney(est.activePerLow) + " - " + fmtMoney(est.activePerHigh);
      document.getElementById("estYou").textContent = estYou;

      // counterparties raw
      const cp = (s.counterparties_sample || []).slice(0,50).map(x => `${x.address} (${x.isContract ? 'contract' : 'EOA'})`).join("\n");
      document.getElementById("counterpartyRaw").textContent = cp || "—";
    }

    btnReset.addEventListener("click", () => {
      document.getElementById("wallet").value = "";
      status.textContent = "";
      report.classList.add("hidden");
      lastResult = null;
    });

    // Export CSV (client-side)
    btnExport.addEventListener("click", () => {
      if (!lastResult) { status.innerHTML = "<span class='text-yellow-300'>No result to export. Run analysis first.</span>"; return; }
      const r = lastResult;
      const s = r.sample || {};
      // create CSV rows
      const rows = [
        ["address", r.address],
        ["tier", r.tier],
        ["score", r.score],
        ["bridged", r.bridged],
        ["dappCounter", r.dappCounter],
        ["sybilRisk", r.sybilRisk],
        ["txCount", s.txCount || 0],
        ["tokenTxCount", s.tokenTxCount || 0],
        ["internalTxCount", s.internalTxCount || 0],
        ["counterparties_count", s.counterparties_count || 0],
        ["firstTx", s.firstTx || ""],
        ["lastTx", s.lastTx || ""],
      ];
      const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${r.address}_base_airdrop_check.csv`;
      a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
